---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cloudagent-cnpg
  namespace: alice
spec:
  imageName: ghcr.io/cloudnative-pg/postgresql:17.4
  instances: 2
  storage:
    size: 5Gi
    storageClass: managed-csi-premium
  enableSuperuserAccess: true
  superuserSecret:
    name: alice-cloudagent-cnpg-superuser-creds
  bootstrap:
    initdb:
      database: walletId
      owner: cloudagent
      secret:
        name: alice-cloudagent-cnpg-creds
      import:
        type: microservice
        databases:
          - walletId
        source:
          externalCluster: cloudagent-postgresql
  externalClusters:
    - name: cloudagent-postgresql
      connectionParameters:
        host: cloudagent-postgresql.alice.svc.cluster.local
        port: "5432"
        user: postgres
        dbname: postgres
      password:
        name: alice-cloudagent-cnpg-superuser-creds
        key: postgres-password
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cloudagent-cnpg
  namespace: alice
spec:
  minAvailable: 1
  selector:
    matchLabels:
      cnpg.io/cluster: cloudagent-cnpg
